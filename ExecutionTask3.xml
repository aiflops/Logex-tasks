<ShowPlanXML xmlns="http://schemas.microsoft.com/sqlserver/2004/07/showplan" Version="1.6" Build="14.0.2027.2">
  <BatchSequence>
    <Batch>
      <Statements>
        <StmtSimple StatementText="SELECT patients.patientid,[firstname],[lastname],[date_of_birth],[gender],most_expensive.year_price&#xD;&#xA;FROM [TASK].[dbo].[test_patients] as patients&#xD;&#xA;inner join (&#xD;&#xA;	SELECT top(1) mt.patient_id as patientid, sum(prices.price) as year_price&#xD;&#xA;	FROM [TASK].[dbo].[test_trajectory_detail] as traject&#xD;&#xA;	inner join [TASK].[dbo].[test_prices] as prices&#xD;&#xA;	on traject.activity_id = prices.activity_id&#xD;&#xA;	inner join TASK.dbo.[test_medical_trajectory] as mt&#xD;&#xA;	on traject.traject_id = mt.traject_id&#xD;&#xA;	where date_performed BETWEEN '01-01-2017' AND '31-12-2017' &#xD;&#xA;	group by mt.patient_id&#xD;&#xA;	order by year_price desc&#xD;&#xA;) as most_expensive&#xD;&#xA;on most_expensive.patientid = patients.patientid" StatementId="1" StatementCompId="1" StatementType="SELECT" RetrievedFromCache="false" StatementSubTreeCost="110.961" StatementEstRows="1" SecurityPolicyApplied="false" StatementOptmLevel="FULL" QueryHash="0x766ABE7F20CBC2FB" QueryPlanHash="0x6E82BF993E6A022A" CardinalityEstimationModelVersion="140">
          <StatementSetOptions QUOTED_IDENTIFIER="true" ARITHABORT="true" CONCAT_NULL_YIELDS_NULL="true" ANSI_NULLS="true" ANSI_PADDING="true" ANSI_WARNINGS="true" NUMERIC_ROUNDABORT="false">
          </StatementSetOptions>
          <QueryPlan NonParallelPlanReason="NoParallelPlansInDesktopOrExpressEdition" CachedPlanSize="88" CompileTime="5" CompileCPU="5" CompileMemory="792">
            <MissingIndexes>
              <MissingIndexGroup Impact="27.7296">
                <MissingIndex Database="[TASK]" Schema="[dbo]" Table="[test_trajectory_detail]">
                  <ColumnGroup Usage="INEQUALITY">
                    <Column Name="[date_performed]" ColumnId="3">
                    </Column>
                  </ColumnGroup>
                  <ColumnGroup Usage="INCLUDE">
                    <Column Name="[traject_id]" ColumnId="1">
                    </Column>
                    <Column Name="[activity_id]" ColumnId="2">
                    </Column>
                  </ColumnGroup>
                </MissingIndex>
              </MissingIndexGroup>
              <MissingIndexGroup Impact="47.7034">
                <MissingIndex Database="[TASK]" Schema="[dbo]" Table="[test_trajectory_detail]">
                  <ColumnGroup Usage="EQUALITY">
                    <Column Name="[activity_id]" ColumnId="2">
                    </Column>
                  </ColumnGroup>
                  <ColumnGroup Usage="INEQUALITY">
                    <Column Name="[date_performed]" ColumnId="3">
                    </Column>
                  </ColumnGroup>
                  <ColumnGroup Usage="INCLUDE">
                    <Column Name="[traject_id]" ColumnId="1">
                    </Column>
                  </ColumnGroup>
                </MissingIndex>
              </MissingIndexGroup>
            </MissingIndexes>
            <MemoryGrantInfo SerialRequiredMemory="3072" SerialDesiredMemory="269888">
            </MemoryGrantInfo>
            <OptimizerHardwareDependentProperties EstimatedAvailableMemoryGrant="208622" EstimatedPagesCached="104311" EstimatedAvailableDegreeOfParallelism="4" MaxCompileMemory="7142504">
            </OptimizerHardwareDependentProperties>
            <OptimizerStatsUsage>
              <StatisticsInfo LastUpdate="2020-06-02T17:12:30.01" ModificationCount="0" SamplingPercent="31.281" Statistics="[_WA_Sys_00000002_35BCFE0A]" Table="[test_medical_trajectory]" Schema="[dbo]" Database="[TASK]">
              </StatisticsInfo>
              <StatisticsInfo LastUpdate="2020-06-03T22:33:33.47" ModificationCount="0" SamplingPercent="100" Statistics="[ClusteredIndex_Patient]" Table="[test_patients]" Schema="[dbo]" Database="[TASK]">
              </StatisticsInfo>
              <StatisticsInfo LastUpdate="2020-06-02T17:03:21.53" ModificationCount="0" SamplingPercent="5.18953" Statistics="[_WA_Sys_00000001_36B12243]" Table="[test_trajectory_detail]" Schema="[dbo]" Database="[TASK]">
              </StatisticsInfo>
              <StatisticsInfo LastUpdate="2020-06-02T16:50:07.22" ModificationCount="0" SamplingPercent="5.18953" Statistics="[_WA_Sys_00000003_36B12243]" Table="[test_trajectory_detail]" Schema="[dbo]" Database="[TASK]">
              </StatisticsInfo>
              <StatisticsInfo LastUpdate="2020-06-03T22:28:31.58" ModificationCount="0" SamplingPercent="100" Statistics="[ClusteredIndex_Patient]" Table="[test_medical_trajectory]" Schema="[dbo]" Database="[TASK]">
              </StatisticsInfo>
              <StatisticsInfo LastUpdate="2020-06-02T16:57:35.08" ModificationCount="0" SamplingPercent="5.18953" Statistics="[_WA_Sys_00000002_36B12243]" Table="[test_trajectory_detail]" Schema="[dbo]" Database="[TASK]">
              </StatisticsInfo>
              <StatisticsInfo LastUpdate="2020-06-02T16:57:35.08" ModificationCount="0" SamplingPercent="100" Statistics="[_WA_Sys_00000001_38996AB5]" Table="[test_prices]" Schema="[dbo]" Database="[TASK]">
              </StatisticsInfo>
            </OptimizerStatsUsage>
            <TraceFlags IsCompileTime="1">
              <TraceFlag Value="8017" Scope="Global">
              </TraceFlag>
            </TraceFlags>
            <RelOp NodeId="0" PhysicalOp="Nested Loops" LogicalOp="Inner Join" EstimateRows="1" EstimateIO="0" EstimateCPU="4.18e-006" AvgRowSize="80" EstimatedTotalSubtreeCost="110.961" Parallel="0" EstimateRebinds="0" EstimateRewinds="0" EstimatedExecutionMode="Row">
              <OutputList>
                <ColumnReference Database="[TASK]" Schema="[dbo]" Table="[test_patients]" Alias="[patients]" Column="patientid">
                </ColumnReference>
                <ColumnReference Database="[TASK]" Schema="[dbo]" Table="[test_patients]" Alias="[patients]" Column="firstname">
                </ColumnReference>
                <ColumnReference Database="[TASK]" Schema="[dbo]" Table="[test_patients]" Alias="[patients]" Column="lastname">
                </ColumnReference>
                <ColumnReference Database="[TASK]" Schema="[dbo]" Table="[test_patients]" Alias="[patients]" Column="date_of_birth">
                </ColumnReference>
                <ColumnReference Database="[TASK]" Schema="[dbo]" Table="[test_patients]" Alias="[patients]" Column="gender">
                </ColumnReference>
                <ColumnReference Column="Expr1008">
                </ColumnReference>
              </OutputList>
              <NestedLoops Optimized="0">
                <OuterReferences>
                  <ColumnReference Database="[TASK]" Schema="[dbo]" Table="[test_medical_trajectory]" Alias="[mt]" Column="patient_id">
                  </ColumnReference>
                </OuterReferences>
                <RelOp NodeId="1" PhysicalOp="Sort" LogicalOp="TopN Sort" EstimateRows="1" EstimateIO="0.0112613" EstimateCPU="7.31539" AvgRowSize="19" EstimatedTotalSubtreeCost="110.957" Parallel="0" EstimateRebinds="0" EstimateRewinds="0" EstimatedExecutionMode="Row">
                  <OutputList>
                    <ColumnReference Database="[TASK]" Schema="[dbo]" Table="[test_medical_trajectory]" Alias="[mt]" Column="patient_id">
                    </ColumnReference>
                    <ColumnReference Column="Expr1008">
                    </ColumnReference>
                  </OutputList>
                  <MemoryFractions Input="0.000917431" Output="1">
                  </MemoryFractions>
                  <TopSort Distinct="0" Rows="1">
                    <OrderBy>
                      <OrderByColumn Ascending="0">
                        <ColumnReference Column="Expr1008">
                        </ColumnReference>
                      </OrderByColumn>
                    </OrderBy>
                    <RelOp NodeId="2" PhysicalOp="Hash Match" LogicalOp="Aggregate" EstimateRows="96270.9" EstimateIO="0" EstimateCPU="15.3766" AvgRowSize="19" EstimatedTotalSubtreeCost="103.631" Parallel="0" EstimateRebinds="0" EstimateRewinds="0" EstimatedExecutionMode="Row">
                      <OutputList>
                        <ColumnReference Database="[TASK]" Schema="[dbo]" Table="[test_medical_trajectory]" Alias="[mt]" Column="patient_id">
                        </ColumnReference>
                        <ColumnReference Column="Expr1008">
                        </ColumnReference>
                      </OutputList>
                      <MemoryFractions Input="0.0326517" Output="0.999083">
                      </MemoryFractions>
                      <Hash>
                        <DefinedValues>
                          <DefinedValue>
                            <ColumnReference Column="Expr1008">
                            </ColumnReference>
                            <ScalarOperator ScalarString="SUM([TASK].[dbo].[test_prices].[price] as [prices].[price])">
                              <Aggregate Distinct="0" AggType="SUM">
                                <ScalarOperator>
                                  <Identifier>
                                    <ColumnReference Database="[TASK]" Schema="[dbo]" Table="[test_prices]" Alias="[prices]" Column="price">
                                    </ColumnReference>
                                  </Identifier>
                                </ScalarOperator>
                              </Aggregate>
                            </ScalarOperator>
                          </DefinedValue>
                        </DefinedValues>
                        <HashKeysBuild>
                          <ColumnReference Database="[TASK]" Schema="[dbo]" Table="[test_medical_trajectory]" Alias="[mt]" Column="patient_id">
                          </ColumnReference>
                        </HashKeysBuild>
                        <RelOp NodeId="3" PhysicalOp="Hash Match" LogicalOp="Inner Join" EstimateRows="2.99133e+006" EstimateIO="0" EstimateCPU="31.7033" AvgRowSize="19" EstimatedTotalSubtreeCost="88.254" Parallel="0" EstimateRebinds="0" EstimateRewinds="0" EstimatedExecutionMode="Row">
                          <OutputList>
                            <ColumnReference Database="[TASK]" Schema="[dbo]" Table="[test_prices]" Alias="[prices]" Column="price">
                            </ColumnReference>
                            <ColumnReference Database="[TASK]" Schema="[dbo]" Table="[test_medical_trajectory]" Alias="[mt]" Column="patient_id">
                            </ColumnReference>
                          </OutputList>
                          <MemoryFractions Input="0.99284" Output="0.960422">
                          </MemoryFractions>
                          <Hash>
                            <DefinedValues>
                            </DefinedValues>
                            <HashKeysBuild>
                              <ColumnReference Database="[TASK]" Schema="[dbo]" Table="[test_medical_trajectory]" Alias="[mt]" Column="traject_id">
                              </ColumnReference>
                            </HashKeysBuild>
                            <HashKeysProbe>
                              <ColumnReference Database="[TASK]" Schema="[dbo]" Table="[test_trajectory_detail]" Alias="[traject]" Column="traject_id">
                              </ColumnReference>
                            </HashKeysProbe>
                            <RelOp NodeId="4" PhysicalOp="Clustered Index Scan" LogicalOp="Clustered Index Scan" EstimateRows="1.35071e+006" EstimatedRowsRead="1.35071e+006" EstimateIO="2.10461" EstimateCPU="1.48594" AvgRowSize="15" EstimatedTotalSubtreeCost="3.59055" TableCardinality="1.35071e+006" Parallel="0" EstimateRebinds="0" EstimateRewinds="0" EstimatedExecutionMode="Row">
                              <OutputList>
                                <ColumnReference Database="[TASK]" Schema="[dbo]" Table="[test_medical_trajectory]" Alias="[mt]" Column="traject_id">
                                </ColumnReference>
                                <ColumnReference Database="[TASK]" Schema="[dbo]" Table="[test_medical_trajectory]" Alias="[mt]" Column="patient_id">
                                </ColumnReference>
                              </OutputList>
                              <IndexScan Ordered="0" ForcedIndex="0" ForceScan="0" NoExpandHint="0" Storage="RowStore">
                                <DefinedValues>
                                  <DefinedValue>
                                    <ColumnReference Database="[TASK]" Schema="[dbo]" Table="[test_medical_trajectory]" Alias="[mt]" Column="traject_id">
                                    </ColumnReference>
                                  </DefinedValue>
                                  <DefinedValue>
                                    <ColumnReference Database="[TASK]" Schema="[dbo]" Table="[test_medical_trajectory]" Alias="[mt]" Column="patient_id">
                                    </ColumnReference>
                                  </DefinedValue>
                                </DefinedValues>
                                <Object Database="[TASK]" Schema="[dbo]" Table="[test_medical_trajectory]" Index="[ClusteredIndex_Patient]" Alias="[mt]" IndexKind="Clustered" Storage="RowStore">
                                </Object>
                              </IndexScan>
                            </RelOp>
                            <RelOp NodeId="5" PhysicalOp="Hash Match" LogicalOp="Inner Join" EstimateRows="2.99133e+006" EstimateIO="0" EstimateCPU="16.0231" AvgRowSize="19" EstimatedTotalSubtreeCost="52.9602" Parallel="0" EstimateRebinds="0" EstimateRewinds="0" EstimatedExecutionMode="Row">
                              <OutputList>
                                <ColumnReference Database="[TASK]" Schema="[dbo]" Table="[test_trajectory_detail]" Alias="[traject]" Column="traject_id">
                                </ColumnReference>
                                <ColumnReference Database="[TASK]" Schema="[dbo]" Table="[test_prices]" Alias="[prices]" Column="price">
                                </ColumnReference>
                              </OutputList>
                              <MemoryFractions Input="0.0071599" Output="0.00692612">
                              </MemoryFractions>
                              <Hash>
                                <DefinedValues>
                                </DefinedValues>
                                <HashKeysBuild>
                                  <ColumnReference Database="[TASK]" Schema="[dbo]" Table="[test_prices]" Alias="[prices]" Column="activity_id">
                                  </ColumnReference>
                                </HashKeysBuild>
                                <HashKeysProbe>
                                  <ColumnReference Database="[TASK]" Schema="[dbo]" Table="[test_trajectory_detail]" Alias="[traject]" Column="activity_id">
                                  </ColumnReference>
                                </HashKeysProbe>
                                <RelOp NodeId="6" PhysicalOp="Table Scan" LogicalOp="Table Scan" EstimateRows="1000" EstimatedRowsRead="1000" EstimateIO="0.00534722" EstimateCPU="0.001257" AvgRowSize="19" EstimatedTotalSubtreeCost="0.00660422" TableCardinality="1000" Parallel="0" EstimateRebinds="0" EstimateRewinds="0" EstimatedExecutionMode="Row">
                                  <OutputList>
                                    <ColumnReference Database="[TASK]" Schema="[dbo]" Table="[test_prices]" Alias="[prices]" Column="activity_id">
                                    </ColumnReference>
                                    <ColumnReference Database="[TASK]" Schema="[dbo]" Table="[test_prices]" Alias="[prices]" Column="price">
                                    </ColumnReference>
                                  </OutputList>
                                  <TableScan Ordered="0" ForcedIndex="0" ForceScan="0" NoExpandHint="0" Storage="RowStore">
                                    <DefinedValues>
                                      <DefinedValue>
                                        <ColumnReference Database="[TASK]" Schema="[dbo]" Table="[test_prices]" Alias="[prices]" Column="activity_id">
                                        </ColumnReference>
                                      </DefinedValue>
                                      <DefinedValue>
                                        <ColumnReference Database="[TASK]" Schema="[dbo]" Table="[test_prices]" Alias="[prices]" Column="price">
                                        </ColumnReference>
                                      </DefinedValue>
                                    </DefinedValues>
                                    <Object Database="[TASK]" Schema="[dbo]" Table="[test_prices]" Alias="[prices]" IndexKind="Heap" Storage="RowStore">
                                    </Object>
                                  </TableScan>
                                </RelOp>
                                <RelOp NodeId="7" PhysicalOp="Table Scan" LogicalOp="Table Scan" EstimateRows="2.99464e+006" EstimatedRowsRead="9.45895e+006" EstimateIO="18.2016" EstimateCPU="10.405" AvgRowSize="18" EstimatedTotalSubtreeCost="28.6066" TableCardinality="9.45895e+006" Parallel="0" EstimateRebinds="0" EstimateRewinds="0" EstimatedExecutionMode="Row">
                                  <OutputList>
                                    <ColumnReference Database="[TASK]" Schema="[dbo]" Table="[test_trajectory_detail]" Alias="[traject]" Column="traject_id">
                                    </ColumnReference>
                                    <ColumnReference Database="[TASK]" Schema="[dbo]" Table="[test_trajectory_detail]" Alias="[traject]" Column="activity_id">
                                    </ColumnReference>
                                  </OutputList>
                                  <TableScan Ordered="0" ForcedIndex="0" ForceScan="0" NoExpandHint="0" Storage="RowStore">
                                    <DefinedValues>
                                      <DefinedValue>
                                        <ColumnReference Database="[TASK]" Schema="[dbo]" Table="[test_trajectory_detail]" Alias="[traject]" Column="traject_id">
                                        </ColumnReference>
                                      </DefinedValue>
                                      <DefinedValue>
                                        <ColumnReference Database="[TASK]" Schema="[dbo]" Table="[test_trajectory_detail]" Alias="[traject]" Column="activity_id">
                                        </ColumnReference>
                                      </DefinedValue>
                                    </DefinedValues>
                                    <Object Database="[TASK]" Schema="[dbo]" Table="[test_trajectory_detail]" Alias="[traject]" IndexKind="Heap" Storage="RowStore">
                                    </Object>
                                    <Predicate>
                                      <ScalarOperator ScalarString="[TASK].[dbo].[test_trajectory_detail].[date_performed] as [traject].[date_performed]&gt;='2017-01-01' AND [TASK].[dbo].[test_trajectory_detail].[date_performed] as [traject].[date_performed]&lt;='2017-12-31'">
                                        <Logical Operation="AND">
                                          <ScalarOperator>
                                            <Compare CompareOp="GE">
                                              <ScalarOperator>
                                                <Identifier>
                                                  <ColumnReference Database="[TASK]" Schema="[dbo]" Table="[test_trajectory_detail]" Alias="[traject]" Column="date_performed">
                                                  </ColumnReference>
                                                </Identifier>
                                              </ScalarOperator>
                                              <ScalarOperator>
                                                <Const ConstValue="'2017-01-01'">
                                                </Const>
                                              </ScalarOperator>
                                            </Compare>
                                          </ScalarOperator>
                                          <ScalarOperator>
                                            <Compare CompareOp="LE">
                                              <ScalarOperator>
                                                <Identifier>
                                                  <ColumnReference Database="[TASK]" Schema="[dbo]" Table="[test_trajectory_detail]" Alias="[traject]" Column="date_performed">
                                                  </ColumnReference>
                                                </Identifier>
                                              </ScalarOperator>
                                              <ScalarOperator>
                                                <Const ConstValue="'2017-12-31'">
                                                </Const>
                                              </ScalarOperator>
                                            </Compare>
                                          </ScalarOperator>
                                        </Logical>
                                      </ScalarOperator>
                                    </Predicate>
                                  </TableScan>
                                </RelOp>
                              </Hash>
                            </RelOp>
                          </Hash>
                        </RelOp>
                      </Hash>
                    </RelOp>
                  </TopSort>
                </RelOp>
                <RelOp NodeId="8" PhysicalOp="Clustered Index Seek" LogicalOp="Clustered Index Seek" EstimateRows="1" EstimatedRowsRead="1" EstimateIO="0.003125" EstimateCPU="0.0001581" AvgRowSize="72" EstimatedTotalSubtreeCost="0.0032831" TableCardinality="300000" Parallel="0" EstimateRebinds="0" EstimateRewinds="0" EstimatedExecutionMode="Row">
                  <OutputList>
                    <ColumnReference Database="[TASK]" Schema="[dbo]" Table="[test_patients]" Alias="[patients]" Column="patientid">
                    </ColumnReference>
                    <ColumnReference Database="[TASK]" Schema="[dbo]" Table="[test_patients]" Alias="[patients]" Column="firstname">
                    </ColumnReference>
                    <ColumnReference Database="[TASK]" Schema="[dbo]" Table="[test_patients]" Alias="[patients]" Column="lastname">
                    </ColumnReference>
                    <ColumnReference Database="[TASK]" Schema="[dbo]" Table="[test_patients]" Alias="[patients]" Column="date_of_birth">
                    </ColumnReference>
                    <ColumnReference Database="[TASK]" Schema="[dbo]" Table="[test_patients]" Alias="[patients]" Column="gender">
                    </ColumnReference>
                  </OutputList>
                  <IndexScan Ordered="1" ScanDirection="FORWARD" ForcedIndex="0" ForceSeek="0" ForceScan="0" NoExpandHint="0" Storage="RowStore">
                    <DefinedValues>
                      <DefinedValue>
                        <ColumnReference Database="[TASK]" Schema="[dbo]" Table="[test_patients]" Alias="[patients]" Column="patientid">
                        </ColumnReference>
                      </DefinedValue>
                      <DefinedValue>
                        <ColumnReference Database="[TASK]" Schema="[dbo]" Table="[test_patients]" Alias="[patients]" Column="firstname">
                        </ColumnReference>
                      </DefinedValue>
                      <DefinedValue>
                        <ColumnReference Database="[TASK]" Schema="[dbo]" Table="[test_patients]" Alias="[patients]" Column="lastname">
                        </ColumnReference>
                      </DefinedValue>
                      <DefinedValue>
                        <ColumnReference Database="[TASK]" Schema="[dbo]" Table="[test_patients]" Alias="[patients]" Column="date_of_birth">
                        </ColumnReference>
                      </DefinedValue>
                      <DefinedValue>
                        <ColumnReference Database="[TASK]" Schema="[dbo]" Table="[test_patients]" Alias="[patients]" Column="gender">
                        </ColumnReference>
                      </DefinedValue>
                    </DefinedValues>
                    <Object Database="[TASK]" Schema="[dbo]" Table="[test_patients]" Index="[ClusteredIndex_Patient]" Alias="[patients]" IndexKind="Clustered" Storage="RowStore">
                    </Object>
                    <SeekPredicates>
                      <SeekPredicateNew>
                        <SeekKeys>
                          <Prefix ScanType="EQ">
                            <RangeColumns>
                              <ColumnReference Database="[TASK]" Schema="[dbo]" Table="[test_patients]" Alias="[patients]" Column="patientid">
                              </ColumnReference>
                            </RangeColumns>
                            <RangeExpressions>
                              <ScalarOperator ScalarString="[TASK].[dbo].[test_medical_trajectory].[patient_id] as [mt].[patient_id]">
                                <Identifier>
                                  <ColumnReference Database="[TASK]" Schema="[dbo]" Table="[test_medical_trajectory]" Alias="[mt]" Column="patient_id">
                                  </ColumnReference>
                                </Identifier>
                              </ScalarOperator>
                            </RangeExpressions>
                          </Prefix>
                        </SeekKeys>
                      </SeekPredicateNew>
                    </SeekPredicates>
                  </IndexScan>
                </RelOp>
              </NestedLoops>
            </RelOp>
          </QueryPlan>
        </StmtSimple>
      </Statements>
    </Batch>
  </BatchSequence>
</ShowPlanXML>
